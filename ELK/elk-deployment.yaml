apiVersion: v1
kind: Pod
metadata:
  name: elk-pod
  labels:
    app: elk
spec:
  containers:
    - name: elasticsearch
      image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
      ports:
        - containerPort: 9200
      env:
        - name: discovery.type
          value: single-node
        - name: xpack.security.enabled
          value: "false"
        - name: bootstrap.memory_lock
          value: "true"
        - name: ES_JAVA_OPTS
          value: "-Xms1g -Xmx1g"
      resources:
        limits:
          memory: 2Gi
          cpu: "1"
        requests:
          memory: 1Gi
          cpu: "0.5"
      volumeMounts:
        - name: es-data
          mountPath: /usr/share/elasticsearch/data

    - name: logstash
      image: docker.elastic.co/logstash/logstash:8.13.4
      ports:
        - containerPort: 5000
        - containerPort: 9600
      resources:
        limits:
          memory: "1Gi"
          cpu: "0.5"
        requests:
          memory: "512Mi"
          cpu: "0.25"
      volumeMounts:
        - name: logstash-pipeline
          mountPath: /usr/share/logstash/pipeline/logstash.conf
          subPath: logstash.conf

    - name: kibana
      image: docker.elastic.co/kibana/kibana:8.13.4
      ports:
        - containerPort: 5601
      env:
        - name: ELASTICSEARCH_HOSTS
          value: http://localhost:9200
      resources:
        limits:
          memory: "1Gi"
          cpu: "0.5"
        requests:
          memory: "512Mi"
          cpu: "0.25"

  volumes:
    - name: es-data
      emptyDir: {}

    - name: logstash-pipeline
      configMap:
        name: logstash-pipeline
---
apiVersion: v1
kind: Service
metadata:
  name: elk-service
spec:
  type: ClusterIP
  selector:
    app: elk
  ports:
    - name: elasticsearch
      port: 9200
      targetPort: 9200
    - name: logstash
      port: 5000
      targetPort: 5000
    - name: logstash-monitor
      port: 9600
      targetPort: 9600
    - name: kibana
      port: 5601
      targetPort: 5601
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-pipeline
data:
  logstash.conf: |
    input {
      tcp {
        port  => 5000
        codec => json_lines
      }
    }

    filter {
    date {
      match  => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    mutate {
      remove_field => ["timestamp"]
      add_field    => { "project" => "webrtc_project" }
    }

    # # tag logs that have a specific WebRTC field (replace 'webrtc_specific_field' with the actual key)
    # if [webrtc_specific_field] {
    #     mutate {
    #         add_tag => ["webrtc"]
    #     }
      # }
    }

    output {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "webrtc-logs-%{+YYYY.MM.dd}"
      }

      stdout {
        codec => rubydebug
      }
    }

